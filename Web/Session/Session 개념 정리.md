# `Session 개념 정리`

이번 글에서는 세션이 무엇인지 간단하게 알아보고 `세션`으로 로그인을 처리하는 방식에 대해서 이론으로 알아보겠습니다. 

일반적으로 세션은 아래와 같은 로직으로 저장이 됩니다. 

- 클라이언트의 HTTP 요청 기반으로 하나의 세션이 설정됩니다. (`unique session ID`)

- 클라이언트마다 개별적으로 생성되어 일정 시간 동안 유지됩니다. 

<br>

`WAS` 한대만 사용한다면 세션 정보를 WAS 내부에 저장을 해도 문제가 없을 것입니다. 그런데 서버를 여러 대 두어야 한다면 어떻게 될까요? 
A라는 서버에 세션을 저장해놓은 후에, B라는 서버로 접속을 하면 로그인이 유지가 안되는 현상이 발생할 것입니다. 그래서 이러한 문제를 해결하기 위한 방법이 3가지 정도 있는데 그것에 대해 정리해보겠습니다. 

<br>

## `Sticky Session을 사용하자!`

Sticky Session이란 어떠한 사용자의 세션이 1번 서버에서 생성되었다면 이 사용자의 Request는 1번 서버로만 보내지는 방식인데요. 이러한 방식을 로드밸런서에서 제공해줍니다.
즉, 세션이 만료되기 전까지는 A 사용자의 세션이 생성된 서버로 로드밸런서가 보내주게 됩니다. 

<img width="601" alt="스크린샷 2021-06-24 오후 11 51 38" src="https://user-images.githubusercontent.com/45676906/123284311-1ebc8e00-d547-11eb-857e-7df018716337.png">

`Sticky Session`을 사용하지 않고 했다면 위와 같이 로드밸런서는 트래픽을 분배할 것입니다. 

<br>

<img width="582" alt="스크린샷 2021-06-25 오전 12 06 52" src="https://user-images.githubusercontent.com/45676906/123286878-401e7980-d549-11eb-8c83-e0893ac12102.png">

반면에 `Sticky Session`을 사용했다면 세션을 만든 곳으로만 트래픽을 분배하게 될 것입니다. 그런데 이러한 방식에는 단점이 존재하는데요. 어떤 단점일까요? 

바로 트래픽이 분산되지 않고 특정 서버에 트래픽에 몰릴 수도 있다는 단점이 존재합니다. 다른 서버가 여유롭더라도 세션 정보가 특정 서버에서만 많이 생성되었다면 그 쪽 서버로만 보내져야 하기 때문입니다. 

그리고 더 크게! 해당 서버에 문제가 생긴다면 세션 정보가 다 삭제가 되기 때문에 문제가 또한 발생할 수 있습니다. 

<br> <br>

## `Cluster Session을 사용해보자!`

![스크린샷 2021-06-25 오전 12 20 08](https://user-images.githubusercontent.com/45676906/123289108-1a926f80-d54b-11eb-994e-aa87ceb8f18c.png)

위의 그림처럼 WAS를 여러 대 사용하고 있을 때 하나의 WAS에서 세션 정보가 변경이 됐다면 나머지 서버에도 변경된 세션 정보를 저장시키는 것을 `세션 클러스터링` 이라고 합니다.

이것은 그냥 보아도 단점이 보이는 거 같습니다. 모든 서버에 같은 세션의 정보를 저장하다 보니 `메모리` 면에서 비효율적일 수 있고, 서버가 정말 많다면 그 많은 서버에 세션 정보를 변경시키는 것은 쉽지 않을 것입니다. 

<br>

## `Redis로 Session을 관리하자!`

![스크린샷 2021-06-25 오전 12 29 20](https://user-images.githubusercontent.com/45676906/123290643-685ba780-d54c-11eb-83b3-4a246187677b.png)

현재 프로젝트에서 저도 위와 같이 WAS를 여러 대 사용하고 있는데요. 이 때 Redis 데이터 정합성을 보장하기 위해서 AWS ElastiCache를 사용해서 저장하고 데이터를 조회하고 있습니다. 

> 따라서 서버들끼리 네트워크 요청을 할 필요도 없고 서버를 stateless하게 유지할 수 있다는 점에서 세션 클러스터링 방식의 단점을 극복한 방식입니다. 
> 또한 한 서버에 문제가 생겨도 외부에 세션정보를 저장하여 서버 장애 문제를 극복하고 한대의 서버에 트래픽이 몰릴일이 없어졌기 때문에 스티키 세션의 방법을 극복한 방식입니다. 
> 따라서 레디스를 이용해 서버 외부에서 세션정보를 관리하기로 결정하였습니다.
> 
> Reference: https://tjdrnr05571.tistory.com/3