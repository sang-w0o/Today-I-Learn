# `Spring Layer에 대해서 정리하기`

이번 글에서는 `Spring`으로 개발할 때 많이 사용하는 `Controller`, `Service`, `DTO`, `Repository` 같은 계층 구조를 많이 사용하게 되는데요. 이 때 각 계층이 어떤 역할을 하는지 대략적으로는 알고 쓰지만, 기계적으로 사용하는 느낌도 있어서 이번 글에서 한번 정리해보려 합니다.
(이번 글의 내용은 정답이 아니라 제가 개발하면서, 공부하면서 느꼈던 부분에 대해서 정리해보려 합니다! 틀리거나 부족한 부분이 많을 것입니다,,)

<br> <br>

## `Spring Web Layer`

![image](https://user-images.githubusercontent.com/45676906/140464604-aa034b26-4222-4eea-a009-f23c464ee63f.png)

Spring에서 자주 사용하는 계층을 크게 그림으로 나타내보면 위와 같습니다. 각 영역의 역할을 정리하면 아래와 같은데요. 

- ### `Web Layer`
  - `컨트롤러(@Controller)`와 `JSP` 등의 뷰 템플릿 영역입니다. 
  - `Filter`, `Interceptor`, `Controller Advice` 등 외부 요청과 응답에 대한 전반적인 영역을 의미합니다. 

- ### `Service Layer`
  - `@Service`에서 사용되는 영역입니다. 
  - 다들 많이 사용하듯이 `Controller`, `DAO` 중간에 존재하는 계층입니다.
  - `@Transactional`이 사용되어야 하는 영역입니다. 

- ### `Repository Layer`
  - `DataBase`와 같이 데이터 저장소에 접근하는 영역입니다.(MyBatis 라면 `Mapper`)

- ### `DTOs`
  - `DTO(Data Transfer Object)`는 `계층 간의 데이터 교환을 위한 객체`를 말합니다. 

- ### `Domain Model`
  - `Domain`이 저에게는 아직도 이해하기 힘든 부분이라고 생각합니다..
  - `@Entity`가 사용된 영역을 도메인 영역으로 이해하면 좋습니다.
  - 무조건 데이터베이스 테이블과 관련이 있어야 하는 것은 아닙니다. 

<br>

위의 `Web`, `Service`, `Repository`, `DTO`, `Domain` 중에서 `비즈니스 로직`을 처리해야 하는 곳은 바로 `Domain` 영역입니다. `Service` 계층에서 모든 비즈니스 로직을 처리하는 방식은 `트랜잭션 스크립트` 이라고 합니다. 스프링으로 처음으로 개발할 때는 저도 `트랜잭션 스크립트` 방식으로 개발을 해왔는데요. 

트랜잭션 스크립트 방식을 사용하면서 느낀 점은 코드가 `객체지향적`이라기 보다는 `절차지향적`으로 되어 가는 것 같다고 많이 느꼈습니다. 그리고 비즈니스 로직이 복잡해질 수록 `Service` 계층의 코드도 거대해져서 관리하기도 쉽지 않다고도 느꼈습니다. 

그래서 저는 `비즈니스 로직은 도메인이 가져가고 서비스 계층은 트랜잭션 순서만 처리`하는 `도메인 모델` 방식을 더 선호합니다. 도메인 모델 방식으로 코드를 작성하면 `객체의 역할과 책임`을 좀 더 명확하게 구분하여 `코드의 응집력`을 높일 수 있다고 생각하기 때문입니다.

<br> <br>

## `클라이언트에게 요청을 받아온 DTO를 DB Layer에서 Entity로 변환할 것`

일반적으로 Spring에서 `HTTP POST` 방식의 INSERT API에서 `Request Body` 데이터를 `Request DTO`를 통해서 받아올 것입니다. 그리고 해당 DTO를 `Entity`로 변환하여 `DB Layer`에 데이터를 영속화시킬 것입니다. 

이렇게 DB Layer에 가기 전에 `DTO -> Entity`로 변환하는 작업이 필요한 이유가 무엇일까요? 일단 변환하지 않고 `DTO`를 바로 `DB Layer 영속화 하는데 사용한다면 View 영역과 DB Layer 영역이 의존이 생길 수 밖에 없습니다.` 예를들어, View가 바껴서 클라이언트로 부터 받아오는 데이터가 추가되었다면 추가된 것은 View 영역인데 `Domain` 영역에도 영향을 미칠 수 밖에 없습니다. 

그러면 위에서 보았던 그림처럼 각 계층의 역할도 모호해지고 계층을 나누어서 작업하는 장점이 점점 줄어들 것입니다. (유지보수 하기가 쉽지 않은,,) 

![스크린샷 2021-11-17 오전 2 08 18](https://user-images.githubusercontent.com/45676906/142032091-c37f480a-484c-4f75-92ab-93e2396ea051.png)

위처럼 `회원가입`을 위해서 `클라이언트로부터 받아오는 데이터를 DTO`로 받고 있습니다. 

<br>

![스크린샷 2021-11-17 오전 2 10 42](https://user-images.githubusercontent.com/45676906/142032503-f31b6a50-f067-47ed-b006-4a89c8dabf22.png)

그리고 `DB Layer`로 들어갈 때는 `DTO -> Entity`로 변환한 후에 들어가는데요. 이렇게 `View Layer`, `DB Layer`를 분리시켜놔야 한 쪽에서 변경이 일어나도 Layer 간에 의존적이지 않을 수 있다고 생각합니다.

<br> <br> 

## `클라이언트에게 응답을 줄 때는 무조건 DTO를 사용할 것`

`Entity` 클래스는 데이터베이스와 밀접하게 연관되어 있는 클래스입니다. 즉, 컬럼 하나를 추가하고, 스키마를 수정한다던지 등등 Entity를 건드리는 작업을 하는 것은 DBA와 의논한 후에 바꿔야 할 수도 있습니다. 그리고 자주 바뀌는 영역도 아닙니다. 

반면에 사용자가 보는 `클라이언트의 영역인 View는 상시로 변경이 될 수 있는 곳`입니다. 뷰가 바뀌어 응답 데이터 형식을 바꿔야 하는 상황이 있을 것인데요. 이럴 때마다 `Entity`를 수정해야 한다면 정말 비효율적일 것입니다. 그리고 `Entity`를 변경하는 일이 많지는 않지만 `Entity`가 변경이 되었다면, 클라이언트에게 주고 있는 API 형식에도 영향을 줄 것이기 때문에 장애로 이어질 수 있습니다. 

나는 `Entity` 영역을 수정 했는데 `View` 영역에도 영향을 미치는 것과, `View` 영역을 수정했는데 `Domain 영역인 Entity`가 영향을 받는 것이 유지보수 하기에 매우 좋지 않은 문제입니다. 

![스크린샷 2021-11-17 오전 2 14 24](https://user-images.githubusercontent.com/45676906/142033088-e2ef74f9-a531-4aa8-8fe2-2bf69b30883b.png)

<br>

![스크린샷 2021-11-17 오전 2 15 59](https://user-images.githubusercontent.com/45676906/142033349-af3f2429-2347-47d1-83ae-48a051997a88.png)

그래서 저도 `Service Layer`에서 `DB Layer`의 응답인 `Entity`를 `DTO`로 변환해서 클라이언트에게 응답을 주고 있습니다.

<br> 

> 결론은 "View Layer와 DB Layer의 역할을 철저하게 분리하라" 입니다.